# ä½¿ç”¨é“å®¢äº‘çš„Pythoné•œåƒï¼ˆä¸­å›½é•œåƒï¼‰
FROM docker.m.daocloud.io/library/python:3.13-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
# é…ç½®torch hubç¼“å­˜ç›®å½•
ENV TORCH_HOME=/root/.cache/torch
ENV TORCH_HUB_DIR=/root/.cache/torch/hub

WORKDIR /app

ARG EXTRAS
ARG HF_PRECACHE_DIR
ARG HF_TKN_FILE

# Debianæºé…ç½®ï¼ˆHTTPâ†’HTTPSæ™ºèƒ½åˆ‡æ¢ç­–ç•¥ï¼‰
RUN echo "ğŸ‡¨ğŸ‡³ é…ç½®Debiané•œåƒæº..." && \
    # å¤‡ä»½åŸå§‹æº
    cp /etc/apt/sources.list /etc/apt/sources.list.backup 2>/dev/null || true && \
    # ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
    echo 'deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware' > /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian-security bookworm-security main contrib non-free non-free-firmware' >> /etc/apt/sources.list && \
    # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…ca-certificates
    apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    # å‡çº§ä¸ºHTTPSæº
    sed -i 's|http://|https://|g' /etc/apt/sources.list && \
    apt-get update && \
    # å®‰è£…ä¾èµ–åŒ…
    apt-get install -y --no-install-recommends \
        ffmpeg \
        git \
        build-essential \
        python3-dev && \
    rm -rf /var/lib/apt/lists/* && \
    echo "âœ… Debianæºé…ç½®å®Œæˆ"

# é…ç½®pipä½¿ç”¨ä¸­å›½é•œåƒæº
RUN echo "ğŸ‡¨ğŸ‡³ é…ç½®pipé•œåƒæº..." && \
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set install.trusted-host pypi.tuna.tsinghua.edu.cn && \
    pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    echo "âœ… pipé…ç½®å®Œæˆ"

# Install CPU-only PyTorch (ä½¿ç”¨ä¸­å›½é•œåƒæºï¼Œå¸¦é‡è¯•æœºåˆ¶)
RUN echo "ğŸ‡¨ğŸ‡³ å®‰è£…CPUç‰ˆPyTorch..." && \
    (pip install torch torchvision torchaudio -i https://pypi.tuna.tsinghua.edu.cn/simple || \
     pip install torch torchvision torchaudio -i https://pypi.mirrors.ustc.edu.cn/simple || \
     pip install torch torchvision torchaudio -i https://repo.huaweicloud.com/repository/pypi/simple || \
     pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu) && \
    echo "âœ… CPUç‰ˆPyTorchå®‰è£…å®Œæˆ"

COPY . .

# Install WhisperLiveKit directly, allowing for optional dependencies
RUN echo "ğŸ‡¨ğŸ‡³ å®‰è£…WhisperLiveKit..." && \
    if [ -n "$EXTRAS" ]; then \
      echo "Installing with extras: [$EXTRAS]"; \
      (pip install --no-cache-dir whisperlivekit[$EXTRAS] -i https://pypi.tuna.tsinghua.edu.cn/simple || \
       pip install --no-cache-dir whisperlivekit[$EXTRAS] -i https://pypi.mirrors.ustc.edu.cn/simple || \
       pip install --no-cache-dir whisperlivekit[$EXTRAS] -i https://repo.huaweicloud.com/repository/pypi/simple || \
       pip install --no-cache-dir whisperlivekit[$EXTRAS]); \
    else \
      echo "Installing base package only"; \
      (pip install --no-cache-dir whisperlivekit -i https://pypi.tuna.tsinghua.edu.cn/simple || \
       pip install --no-cache-dir whisperlivekit -i https://pypi.mirrors.ustc.edu.cn/simple || \
       pip install --no-cache-dir whisperlivekit -i https://repo.huaweicloud.com/repository/pypi/simple || \
       pip install --no-cache-dir whisperlivekit); \
    fi && \
    echo "âœ… WhisperLiveKitå®‰è£…å®Œæˆ"

# Enable in-container caching for Hugging Face models
VOLUME ["/root/.cache/huggingface/hub"]

# Conditionally copy a local pre-cache from the build context
RUN if [ -n "$HF_PRECACHE_DIR" ]; then \
      echo "Copying Hugging Face cache from $HF_PRECACHE_DIR"; \
      mkdir -p /root/.cache/huggingface/hub && \
      cp -r $HF_PRECACHE_DIR/* /root/.cache/huggingface/hub; \
    else \
      echo "No local Hugging Face cache specified, skipping copy"; \
    fi

# Conditionally copy a Hugging Face token if provided
RUN if [ -n "$HF_TKN_FILE" ]; then \
      echo "Copying Hugging Face token from $HF_TKN_FILE"; \
      mkdir -p /root/.cache/huggingface && \
      cp $HF_TKN_FILE /root/.cache/huggingface/token; \
    else \
      echo "No Hugging Face token file specified, skipping token setup"; \
    fi
    
# Expose port for the transcription server
EXPOSE 8000

ENTRYPOINT ["whisperlivekit-server", "--host", "0.0.0.0"]

# Default args - you might want to use a smaller model for CPU
CMD ["--model", "tiny"]